---
phase: 02-3d-viewer-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - src/ui/ExerciseSelector.ts
  - src/core/store.ts
  - src/main.ts
  - src/style.css
  - src/ui/FormGuide.ts
autonomous: true
requirements: [VIEW-01, VIEW-02, VIEW-03, NAV-01, NAV-02, NAV-04]

must_haves:
  truths:
    - "Active exercise in the left panel is indicated by a colored left border, not a background highlight"
    - "An 'Exercises' header label appears above the exercise list in the left panel"
    - "User can collapse the left panel and the 3D viewer expands to fill the freed space"
    - "User can collapse the right panel and the 3D viewer expands to fill the freed space"
    - "Collapsed panels can be re-expanded to their original width"
    - "The form guide highlights the currently active step in sync with the animation progress"
    - "Active step highlighting updates smoothly every frame without flicker at loop boundaries"
  artifacts:
    - path: "src/ui/ExerciseSelector.ts"
      provides: "Left-border active exercise indicator"
      contains: "border-l-2"
    - path: "index.html"
      provides: "Exercises header label and collapse toggle buttons"
      contains: "Exercises"
    - path: "src/core/store.ts"
      provides: "Panel collapse state and setters"
      contains: "leftPanelCollapsed"
    - path: "src/ui/FormGuide.ts"
      provides: "Animation-synchronized active step highlighting"
      contains: "requestAnimationFrame"
  key_links:
    - from: "src/core/store.ts"
      to: "src/main.ts"
      via: "store subscription toggles panel CSS classes"
      pattern: "leftPanelCollapsed|rightPanelCollapsed"
    - from: "src/ui/FormGuide.ts"
      to: "src/core/animationRef.ts"
      via: "RAF loop reads animation time for step sync"
      pattern: "getAnimationController.*getTime"
---

<objective>
Close the three remaining UI gaps between the current implementation and Phase 2 CONTEXT.md decisions: (1) left-border active exercise indicator with "Exercises" header, (2) collapsible side panels, and (3) animation-synchronized active step highlighting in the form guide.

Purpose: Phase 2 features are ~80% implemented from Phase 1 execution. This plan addresses the 3 specific UI gaps identified in research so all Phase 2 success criteria and CONTEXT.md locked decisions are fully satisfied.

Output: All Phase 2 requirements met — the three-panel layout with collapsible panels, correct exercise selector styling, and synchronized form guide step highlighting.
</objective>

<execution_context>
@C:/Users/kyles/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kyles/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-3d-viewer-core/02-CONTEXT.md
@.planning/phases/02-3d-viewer-core/02-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Exercise selector left-border indicator and "Exercises" header</name>
  <files>index.html, src/ui/ExerciseSelector.ts</files>
  <action>
Two changes to align the exercise selector with CONTEXT.md locked decisions:

**1. Add "Exercises" header label in index.html:**

In `index.html`, inside `#panel-left`, add a label between the existing `<header>` and the `<nav id="exercise-list">`:

```html
<div class="px-4 pt-3 pb-1">
  <span class="text-xs font-medium text-white/40 uppercase tracking-wider">Exercises</span>
</div>
```

This goes AFTER the `<header class="px-4 py-3">` block and BEFORE `<nav id="exercise-list"...>`.

**2. Change active exercise indicator in ExerciseSelector.ts:**

In `src/ui/ExerciseSelector.ts`, replace the current active class `'bg-accent/20 text-accent font-medium'` with a left-border style. Replace the inactive class too so both have matching border-l-2 structure.

Change the className assignment to:
```typescript
btn.className =
  'w-full text-left px-3 py-2 text-sm transition-colors border-l-2 ' +
  (id === selectedExerciseId
    ? 'border-accent text-accent font-medium bg-accent/10'
    : 'border-transparent text-white/70 hover:text-white hover:bg-white/5')
```

Key changes:
- Both active and inactive get `border-l-2` (active = `border-accent`, inactive = `border-transparent`)
- Active uses `bg-accent/10` (subtle, not 20) + `text-accent font-medium` + colored left border
- Inactive uses `border-transparent` so the text alignment stays consistent
- Removed `rounded-lg` (borders on one side look odd with rounded corners)
  </action>
  <verify>Run `npm run build` — no TypeScript or build errors. Visually: the active exercise shows a colored left border and the "Exercises" label appears above the list.</verify>
  <done>Active exercise indicator uses a colored left border (border-l-2 border-accent) per CONTEXT.md decision. "Exercises" header label is visible above the exercise list.</done>
</task>

<task type="auto">
  <name>Task 2: Collapsible side panels with store state and toggle buttons</name>
  <files>src/core/store.ts, index.html, src/main.ts, src/style.css</files>
  <action>
Add collapsible side panels per CONTEXT.md locked decision: "Side panels are collapsible to give the viewer full width."

**1. Add panel collapse state to store.ts:**

Add to the `AppState` interface:
```typescript
leftPanelCollapsed: boolean
rightPanelCollapsed: boolean
setLeftPanelCollapsed: (v: boolean) => void
setRightPanelCollapsed: (v: boolean) => void
```

Add to the `createStore` initial state:
```typescript
leftPanelCollapsed: false,
rightPanelCollapsed: false,
setLeftPanelCollapsed: (v) => set({ leftPanelCollapsed: v }),
setRightPanelCollapsed: (v) => set({ rightPanelCollapsed: v }),
```

**2. Add collapse toggle buttons in index.html:**

Add a collapse button inside `#panel-left` at the very top of the aside (before the header). Use a small chevron button at the top-right corner of the panel:

In `#panel-left`, add as the first child a relative position wrapper or place the button absolutely. Simpler approach: add a button row after the header with a toggle button.

Actually, a cleaner approach: Add the toggle buttons OUTSIDE the panels, as thin strips at the panel edges that remain visible when panels are collapsed. Place them inside `#panel-center`:

In `index.html`, inside `<main id="panel-center">`, add two collapse toggle buttons:
```html
<button id="toggle-left" class="absolute left-2 top-2 z-20 w-6 h-6 rounded bg-surface/80 border border-white/10 text-white/50 hover:text-white hover:bg-white/20 text-xs flex items-center justify-center cursor-pointer transition-colors" title="Toggle left panel">‹</button>
<button id="toggle-right" class="absolute right-2 top-2 z-20 w-6 h-6 rounded bg-surface/80 border border-white/10 text-white/50 hover:text-white hover:bg-white/20 text-xs flex items-center justify-center cursor-pointer transition-colors" title="Toggle right panel">›</button>
```

**3. Add panel collapse CSS transitions in style.css:**

Add after the existing `#panel-center canvas` rule:
```css
#panel-left,
#panel-right {
  transition: width 200ms ease, opacity 200ms ease, padding 200ms ease;
  overflow: hidden;
}

#panel-left.collapsed,
#panel-right.collapsed {
  width: 0;
  padding: 0;
  opacity: 0;
  pointer-events: none;
}
```

**4. Wire collapse behavior in main.ts:**

After `mountAnnotationOverlay(centerPanel)`, add panel collapse wiring:

```typescript
// Panel collapse controls
const panelLeft = document.getElementById('panel-left')!
const panelRight = document.getElementById('panel-right')!
const toggleLeft = document.getElementById('toggle-left')!
const toggleRight = document.getElementById('toggle-right')!

toggleLeft.addEventListener('click', () => {
  const { leftPanelCollapsed, setLeftPanelCollapsed } = appStore.getState()
  setLeftPanelCollapsed(!leftPanelCollapsed)
})

toggleRight.addEventListener('click', () => {
  const { rightPanelCollapsed, setRightPanelCollapsed } = appStore.getState()
  setRightPanelCollapsed(!rightPanelCollapsed)
})

appStore.subscribe((state) => {
  panelLeft.classList.toggle('collapsed', state.leftPanelCollapsed)
  panelRight.classList.toggle('collapsed', state.rightPanelCollapsed)
  toggleLeft.textContent = state.leftPanelCollapsed ? '›' : '‹'
  toggleRight.textContent = state.rightPanelCollapsed ? '‹' : '›'
})
```

The toggle button text flips direction to indicate "click to expand" vs "click to collapse." The ResizeObserver in renderer.ts automatically handles canvas resizing when the center panel width changes — no additional renderer code needed (confirmed in research as Pitfall 3).
  </action>
  <verify>Run `npm run build` — no TypeScript or build errors. Click the left toggle button — left panel collapses, viewer expands. Click again — panel re-expands. Same for right panel. Both panels can be collapsed simultaneously.</verify>
  <done>Both side panels can be collapsed and expanded via toggle buttons. Collapsed panels animate to zero width with a 200ms CSS transition. The center 3D viewer automatically fills the freed space. Toggle buttons remain visible in the viewer corners.</done>
</task>

<task type="auto">
  <name>Task 3: Animation-synchronized active step highlighting in form guide</name>
  <files>src/ui/FormGuide.ts</files>
  <action>
Add a RAF (requestAnimationFrame) loop to the form guide that highlights the current form step based on animation progress. Per CONTEXT.md: "Active step highlights in sync with the animation phase as it plays."

**In `src/ui/FormGuide.ts`:**

1. Add import for `getAnimationController` at the top:
```typescript
import { getAnimationController } from '../core/animationRef'
```

2. After the existing `render()` and `appStore.subscribe(render)` calls at the bottom of `mountFormGuide`, add a RAF loop for active step sync:

```typescript
// RAF loop for animation-synchronized active step highlighting
let rafId = 0

function syncActiveStep() {
  const ctrl = getAnimationController()
  if (ctrl) {
    const dur = ctrl.getDuration()
    if (dur > 0) {
      const steps = container.querySelectorAll<HTMLLIElement>('ol li')
      if (steps.length > 0) {
        const normalized = ctrl.getTime() / dur
        const activeIndex = Math.min(
          Math.floor(normalized * steps.length),
          steps.length - 1,
        )
        steps.forEach((li, i) => {
          if (i === activeIndex) {
            li.classList.add('text-white', 'font-medium')
            li.classList.remove('text-white/80')
          } else {
            li.classList.remove('text-white', 'font-medium')
            li.classList.add('text-white/80')
          }
        })
      }
    }
  }
  rafId = requestAnimationFrame(syncActiveStep)
}

rafId = requestAnimationFrame(syncActiveStep)
```

Key design choices (from research — Pitfall 2 and Pitfall 4):
- Uses `Math.min(..., steps.length - 1)` to clamp the index and avoid flicker at loop boundaries when normalized time briefly hits 1.0
- Re-queries `container.querySelectorAll('ol li')` every frame instead of caching references — this avoids stale references after `innerHTML` replacement on exercise switch (Pitfall 4)
- Does NOT store animation time in Zustand store (anti-pattern from research) — reads directly from AnimationController via `getAnimationController()`
- Uses linear time distribution: each step gets equal time share. This is the correct Phase 2 approach per research Open Question 1. Step-specific timing can be added in Phase 4 if needed.
- The active step gets `text-white font-medium` (stands out). Inactive steps stay `text-white/80` (existing default).

3. Ensure the initial `<ol>` items default to `text-white/80` (they already do from the existing `render()` template string).
  </action>
  <verify>Run `npm run build` — no TypeScript or build errors. Open the app, select any exercise, and observe the form guide: as the animation plays, different steps highlight in sequence. When the animation loops, highlighting restarts from step 1. Switching exercises does not break highlighting.</verify>
  <done>Form guide steps highlight in sync with animation progress. Active step shows white text with medium weight. Highlighting loops correctly with the animation. Switching exercises correctly resets highlighting to the new exercise's steps.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. Page loads showing three-panel layout with "Exercises" header in left panel
3. Active exercise shows a colored left border (not just a background highlight)
4. Left panel collapse button works — panel animates to zero width, viewer fills space
5. Right panel collapse button works — same behavior
6. Both panels re-expand on toggle
7. Form guide steps highlight in sequence as the animation plays
8. Step highlighting does not flicker at animation loop boundaries
9. Switching exercises updates the form guide and highlighting continues correctly
10. Camera angle is preserved when switching exercises
11. The site has no account/login requirement (NAV-04 — already satisfied)
</verification>

<success_criteria>
All Phase 2 success criteria from ROADMAP.md are met:
1. Three panels visible simultaneously on dark background (existing + collapsible)
2. 3D viewer shows humanoid model performing exercise on continuous loop (existing)
3. User can click-drag to rotate and scroll to zoom (existing)
4. User can pause/resume animation (existing)
5. User can click any exercise in left panel to switch (existing + left-border indicator)

All CONTEXT.md locked decisions implemented:
- Active exercise indicated by colored left border
- "Exercises" header label above the list
- Side panels are collapsible
- Active step highlights in sync with animation
</success_criteria>

<output>
After completion, create `.planning/phases/02-3d-viewer-core/02-01-SUMMARY.md`
</output>
