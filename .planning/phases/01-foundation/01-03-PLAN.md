---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/animation/keyframe-utils.ts
  - src/animation/AnimationController.ts
  - src/exercises/types.ts
  - src/exercises/registry.ts
  - src/exercises/squat.ts
  - src/main.ts
  - CONTRIBUTING.md
autonomous: true
requirements:
  - TECH-01
  - TECH-02

must_haves:
  truths:
    - "The ExerciseDefinition TypeScript interface is defined with all required fields"
    - "At least one exercise (squat) is registered in the exercise registry"
    - "The squat animation plays on loop using QuaternionKeyframeTrack with smooth interpolation"
    - "A developer can add a new exercise by creating one file in exercises/ and following CONTRIBUTING.md"
  artifacts:
    - path: "src/exercises/types.ts"
      provides: "ExerciseDefinition interface and MuscleId type"
      exports: ["ExerciseDefinition", "MuscleId"]
    - path: "src/exercises/registry.ts"
      provides: "Exercise registry map"
      exports: ["exerciseRegistry"]
    - path: "src/exercises/squat.ts"
      provides: "Squat exercise definition with animation keyframes"
      exports: ["squat"]
    - path: "src/animation/keyframe-utils.ts"
      provides: "Euler-to-quaternion keyframe utilities"
      exports: ["buildQuatTrack", "buildClip"]
    - path: "src/animation/AnimationController.ts"
      provides: "AnimationMixer wrapper"
      exports: ["AnimationController"]
    - path: "CONTRIBUTING.md"
      provides: "Step-by-step guide for adding an exercise"
      min_lines: 30
  key_links:
    - from: "src/exercises/squat.ts"
      to: "src/exercises/types.ts"
      via: "implements ExerciseDefinition"
      pattern: "ExerciseDefinition"
    - from: "src/exercises/registry.ts"
      to: "src/exercises/squat.ts"
      via: "imports and registers squat"
      pattern: "import.*squat"
    - from: "src/animation/AnimationController.ts"
      to: "THREE.AnimationMixer"
      via: "wraps mixer with play/pause/speed"
      pattern: "AnimationMixer"
    - from: "src/exercises/squat.ts"
      to: "src/animation/keyframe-utils.ts"
      via: "builds animation clip from keyframe data"
      pattern: "buildQuatTrack|buildClip"
    - from: "src/main.ts"
      to: "src/exercises/registry.ts"
      via: "loads exercise from registry"
      pattern: "exerciseRegistry"
    - from: "src/main.ts"
      to: "src/mannequin/MannequinBuilder.ts"
      via: "uses mannequin rig for animation"
      pattern: "buildMannequin"
---

<objective>
Create the animation system, config-driven exercise registry, and the first working exercise (squat) that plays on the mannequin in a continuous loop.

Purpose: Proves the complete animation pipeline works end-to-end — from typed exercise definition through keyframe utilities to a visible, looping animation on the mannequin. This is the critical path every Phase 2-5 feature depends on. Also establishes the developer workflow for adding exercises via CONTRIBUTING.md.
Output: A Three.js scene showing the mannequin performing a biomechanically plausible squat on loop, a typed exercise registry with one entry, and a CONTRIBUTING.md documenting how to add new exercises.
</objective>

<execution_context>
@C:/Users/kyles/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kyles/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create animation utilities, AnimationController, exercise types, and squat definition</name>
  <files>
    src/animation/keyframe-utils.ts
    src/animation/AnimationController.ts
    src/exercises/types.ts
    src/exercises/registry.ts
    src/exercises/squat.ts
  </files>
  <action>
Build the animation system and exercise data contract.

**1. src/animation/keyframe-utils.ts:**
- Export `buildQuatTrack(bonePath: string, keyframes: Array<{time, x, y, z}>)` — converts degree Euler angles to quaternions, returns QuaternionKeyframeTrack. Use ZYX Euler order (biomechanical convention). bonePath MUST end in `.quaternion`.
- Export `buildClip(name: string, tracks: KeyframeTrack[], duration?: number)` — creates AnimationClip (duration -1 for auto).
- Export `deg(d: number)` helper (degrees to radians).

**2. src/animation/AnimationController.ts:**
- Export AnimationController class wrapping THREE.AnimationMixer.
- Constructor takes root Object3D (the mannequin root).
- Methods: play(clip) — stops current action, creates new clipAction, sets LoopRepeat Infinity, plays. update() — calls mixer.update(clock.getDelta()). setSpeed(speed) — sets timeScale. setPaused(paused) — sets paused flag.
- Uses its own THREE.Clock instance for delta timing.

**3. src/exercises/types.ts:**
- Export `MuscleId` type (union of string literals): quads, hamstrings, glutes, calves, chest, front-delts, triceps, lats, traps, rear-delts, biceps, core, lower-back, hip-flexors.
- Export `ExerciseDefinition` interface:
  - id: string
  - name: string (display name)
  - primaryMuscles: MuscleId[]
  - secondaryMuscles: MuscleId[]
  - difficulty: 'beginner' | 'intermediate' | 'advanced' (in schema, not displayed v1)
  - formSteps: string[] (3-5 short coaching cues)
  - commonMistakes: string[] (min 2)
  - hasGhostEquipment: boolean
  - buildAnimation: (rig: MannequinRig) => THREE.AnimationClip

**4. src/exercises/squat.ts:**
- Export `squat` conforming to ExerciseDefinition.
- id: 'squat', name: 'Squat', primaryMuscles: ['quads', 'glutes'], secondaryMuscles: ['hamstrings', 'core', 'lower-back']
- difficulty: 'beginner'
- formSteps: 3-5 concise cues (e.g., "Feet shoulder-width apart, toes slightly out", "Push hips back and bend knees simultaneously", "Descend until thighs are parallel to the floor", "Drive through heels to stand back up", "Keep chest up and core braced throughout")
- commonMistakes: at least 2 (e.g., "Knees caving inward — push knees out over toes", "Rising on toes — keep weight in heels")
- hasGhostEquipment: false
- buildAnimation: function that uses buildQuatTrack to create tracks for both hips, both knees, spine, and pelvis. Biomechanically accurate squat:
  - Duration: ~3 seconds per rep (1.5s down, 1.5s up)
  - Hip flexion: ~90-100 degrees at bottom
  - Knee flexion: ~120-130 degrees at bottom
  - Slight forward lean in spine (~15-20 degrees)
  - Ankles dorsiflex slightly (~15 degrees)
  - Return to neutral at end (same as start for seamless loop)
  - Use smooth timing (not perfectly linear — slightly slower at bottom for realistic feel)

**5. src/exercises/registry.ts:**
- Export `exerciseRegistry` as `Map<string, ExerciseDefinition>`
- Register the squat exercise
- Export a `getExercise(id: string)` helper that returns the definition or throws

IMPORTANT: Animation track paths MUST use the exact JointName enum string values from mannequin.types.ts followed by ".quaternion". Example: if JointName.L_KNEE = 'l_knee', then track path = 'l_knee.quaternion'.
IMPORTANT: Squat animation must loop seamlessly — the final keyframe pose must match the initial keyframe pose (both at rest/neutral).
IMPORTANT: Use biomechanically accurate angles — this is a sports science reference tool, not a game.
  </action>
  <verify>
- `npm run build` passes with no TypeScript errors
- Inspect types.ts: ExerciseDefinition has all required fields (id, name, primaryMuscles, secondaryMuscles, difficulty, formSteps, commonMistakes, hasGhostEquipment, buildAnimation)
- Inspect registry.ts: exerciseRegistry.has('squat') would return true
- Inspect squat.ts: squat object has all ExerciseDefinition fields populated
  </verify>
  <done>
ExerciseDefinition interface is defined with all required fields. MuscleId type covers all muscle groups. The squat exercise definition has biomechanically accurate keyframe data. AnimationController wraps AnimationMixer with play/pause/speed controls. The exercise registry contains one entry (squat).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire animation into main.ts and create CONTRIBUTING.md</name>
  <files>
    src/main.ts
    CONTRIBUTING.md
  </files>
  <action>
Wire everything together so the squat animation plays on the mannequin, and document the exercise-adding workflow.

**1. Update src/main.ts:**
- Import the mannequin rig (already built and added to scene by Plan 02)
- Get squat from registry, call buildAnimation(rig) to get the AnimationClip
- Create AnimationController with mannequin root, call play(clip)
- Wire the render loop onTick to call animationController.update()
- Wire Zustand store subscription: when isPlaying changes, call setPaused; when playbackSpeed changes, call setSpeed
- Result: opening the page shows the mannequin performing squats on loop

Note: main.ts was initially created in Plan 01 (placeholder), updated in Plan 02 (mannequin + scene), and now gets animation wiring added. Preserve the existing scene setup and mannequin code — ADD the animation import and wiring on top of it.

**2. CONTRIBUTING.md:**
- Title: "Adding a New Exercise to FormCheck"
- Step-by-step guide:
  1. Create a new file in src/exercises/ (e.g., lunge.ts)
  2. Import ExerciseDefinition, MannequinRig, buildQuatTrack, buildClip
  3. Define the exercise object conforming to ExerciseDefinition interface
  4. Define the buildAnimation function with joint keyframes using JointName enum values
  5. Register in src/exercises/registry.ts (import + add to Map)
  6. Reference: list all available JointName values and what they control
  7. Testing: run `npm run dev`, verify animation plays smoothly, check for console errors
  8. Mention: keyframe angles are in degrees (ZYX Euler order), one rep should loop seamlessly (end pose = start pose)
- Include a minimal code template that can be copied

IMPORTANT: The animation must loop seamlessly — no visible jump at the loop boundary.
IMPORTANT: Store subscription must react to isPlaying and playbackSpeed changes.
  </action>
  <verify>
- `npm run build` passes with no TypeScript errors
- `npm run dev` shows the mannequin performing a squat on continuous loop
- The squat animation looks biomechanically plausible (knees bend, hips hinge, slight forward lean)
- The animation loops without visible jump or pop (seamless start-to-end transition)
- Open browser console — no errors about animation track mismatches or missing properties
- CONTRIBUTING.md exists with clear step-by-step instructions and a code template
  </verify>
  <done>
The mannequin performs a biomechanically plausible squat on continuous loop. The animation loops seamlessly. Zustand store subscriptions control play/pause and speed. CONTRIBUTING.md documents the complete workflow for adding new exercises with a copyable code template. A developer (or Claude) can add a new exercise by creating one file in exercises/ and adding one registry entry.
  </done>
</task>

</tasks>

<verification>
Overall Plan 03 checks:
1. `npm run build` succeeds with no errors
2. `npm run dev` shows a mannequin performing a squat on loop
3. Animation is smooth (no robotic linear motion, no jumps at loop boundary)
4. ExerciseDefinition interface has: id, name, primaryMuscles, secondaryMuscles, difficulty, formSteps, commonMistakes, hasGhostEquipment, buildAnimation
5. exerciseRegistry.get('squat') returns a valid ExerciseDefinition
6. CONTRIBUTING.md exists and is clear enough to follow without additional context
7. Browser console shows no animation track mismatch errors
</verification>

<success_criteria>
- Squat animation plays on continuous loop with smooth motion
- ExerciseDefinition interface is type-safe and complete
- Exercise registry holds at least one exercise (squat)
- CONTRIBUTING.md provides a complete add-exercise workflow with code template
- All joint names match between mannequin builder and animation track paths
- Zustand store controls (play/pause/speed) affect animation playback
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
